# Warden Protocol CLI Guide

This document leads through the features of Warden Protocol 
with the CLI interface and demonstrates the experience 
of interacting with a keychain.

You can also deploy a web application locally. Please follow the steps indicated in [Web Frontend](./SETUP.md#web-frontend).

## Contents

* [Prerequisites](#prerequisites)
* [Start](#start)
    * [Basic Walkthrough](#basic-walkthrough)
    * [Broadcast](#broadcast)
        * [Pregenerated](#pregenerated)
        * [More Transactions](#more-tx)
    * [Manage Spaces](#manage-spaces)
    * [QAssets](#qassets)

## Prerequisites

In case you want to run the blockchain on your own machine, please follow the [Setup](./SETUP.md) document. 

It's suggested to create an alias like this:

```bash
alias w="wardend --node tcp://localhost:26657 --home ~/.wardend/ --from shulgin --gas-prices 1000000000nward"
```

## Start

### Basic Walkthrough

```bash
# create a new space
w tx identity new-space --yes

# check for newly created space
w q identity spaces

# creata a new key of type `ecdsa`` for the space with a time to live of 1000 blocks
w tx treasury new-key-request wardenspace14a2hpadpsy9h5sm54xj wardenkeychain1ph63us46lyw56lmt585 ecdsa 1000 --yes 

# wait for the Keychain (keychain_addr = "wardenkeychain1ph63us46lyw56lmt585") to pick up the request and generate a new key
# you can monitor all the requests with:
w q treasury key-requests wardenkeychain1ph63us46lyw56lmt585 all

# and after the request in fulfilled you will find the public key along with addresses for supported wallet types in warden:
w q treasury keys wardenspace14a2hpadpsy9h5sm54xj

# let's use your new key to sign a payload
# payload must be a 32byte hash of arbitrary data to be singed
w tx treasury new-signature-request 1 '778f572f33acfab831365d52e563a0ddd2829ddd7060bec69719b7e41f6ef91c' 1000 --yes

# after a while you'll be able to retrieve the signature generated by the keychain
w q treasury signature-requests wardenkeychain1ph63us46lyw56lmt585 all
```

### Broadcast

For the wallet address generated in the previous step, make sure it is funded. For this example, we are using `0xC828Bf9126667972400E1ABE600BAAB877B1e674` as an example. 

#### Pregenerated

This unsigned transaction only works for the first transaction to be sent from an address. The transaction looks as follows: 

```
nonce: 0
to: 0x993f45666B2A78434711D1a20D2A9733c07A5318
amount: 4000000000000000 WEI
gasLimit: 21000
gasPrice: 20000000000
data: 
```

Now request the transaction to be signed by the Keychain

```
# submit unsigned tx to be signed
w tx treasury new-sign-transaction-request 1 ethereum eb808504a817c80082520894993f45666b2a78434711d1a20d2a9733c07a5318870e35fa931a000080808080 1000 --yes

# check the tx signature request has been fulfilled
w query treasury sign-transaction-requests ethereum
```

#### More Tx

To create more transactions for that wallet, generate the unsigned tx by yourself:

```bash
# switch to the relayer-eth
cd relayer-eth

# create a unsinged transaction, adjust the nonce
go run ./cmd/buildtx/ -nonce 0 -to 0x993f45666B2A78434711D1a20D2A9733c07A5318 -amount 4000000000000000

# increase the nonce for each new transaction you want to submit
```

### Manage Spaces

You can add and remove owners or adjust intents inside a space. 

```bash
# add a new owner to the space
w tx identity add-space-owner wardenspace14a2hpadpsy9h5sm54xj warden1s3qj9p0ymugy6chyrwy3ft2s5u24fc32q4sg3j 1000 --yes

# check the new owner has been added to the space
w q identity spaces-by-owner warden1s3qj9p0ymugy6chyrwy3ft2s5u24fc32q4sg3j

# remove owner from the space
w tx identity remove-space-owner wardenspace14a2hpadpsy9h5sm54xj warden1s3qj9p0ymugy6chyrwy3ft2s5u24fc32q4sg3j --yes

# check the new owner has been removed to the space
w q identity spaces-by-owner warden1s3qj9p0ymugy6chyrwy3ft2s5u24fc32q4sg3j

# create a new space and append it to an existing one
w tx identity new-child-space wardenspace14a2hpadpsy9h5sm54xj 1000 --yes

# check the indicated space has a new space as child_space
w q identity spaces
```

### Manage Intents

You can add custom intents to warden and assign it to your spaces. 

```bash
## create new intent. define participants of this intent with the default and a second user
w tx intent new-intent test "(p1 + p2) > 0" -p p1:warden1d652c9nngq5cneak2whyaqa4g9ehr8pstxj0r5,p2:warden1s3qj9p0ymugy6chyrwy3ft2s5u24fc32q4sg3j --yes

## check the new intent was created. Investigate the definition and the participants which should be the same as in the previous step
w q intent intents

## update the admin and sign intent of the space to the new intent (id=1)
w tx identity update-space wardenspace14a2hpadpsy9h5sm54xj 1 1 1000 --yes

## check the space has admin_intent_id and signature_intent_id = "1"
w q identity space-by-address wardenspace14a2hpadpsy9h5sm54xj

## create a new intent to later add it to a space
w tx intent new-intent test "(p1) > 0" -p p1:warden1d652c9nngq5cneak2whyaqa4g9ehr8pstxj0r5 --yes

## check if the new intent with id="2" was created.
w q intent intents

## update the admin intent of the space with the new intent (id="2")
w tx identity update-space wardenspace14a2hpadpsy9h5sm54xj 2 1 1000 --yes

## check the space has admin_intent_id = "2" and signature_intent_id = "1"
w q identity space-by-address wardenspace14a2hpadpsy9h5sm54xj
```
